!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.PusherPlatform=t():e.PusherPlatform=t()}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return e[r].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t){"use strict";function n(e){var t={};if(!e)return t;for(var n=e.split("\r\n"),r=0;r<n.length;r++){var o=n[r],s=o.indexOf(": ");if(s>0){var i=o.substring(0,s),a=o.substring(s+2);t[i]=a}}return t}function r(e){return atob(e.replace(/\-/g,"+").replace(/_/g,"/"))}var o=function(){function e(e){this.statusCode=e.status,this.headers=n(e.getAllResponseHeaders()),this.info=e.responseText}return e}(),s=function(){function e(e,t){var n=this;this.xhr=e,this.options=t,this.gotEOS=!1,this.calledOnOpen=!1,this.lastNewlineIndex=0,this.xhr.onreadystatechange=function(){if(3===n.xhr.readyState){if(200===n.xhr.status){n.opened();var t=n.onChunk();null!=t&&(n.xhr.abort(),n.options.onError&&n.options.onError(t))}}else if(4===n.xhr.readyState)if(200===n.xhr.status){n.opened();var t=n.onChunk();null!==t&&void 0!=t?n.options.onError&&n.options.onError(t):n.gotEOS?n.options.onEnd&&n.options.onEnd():n.options.onError&&n.options.onError(new Error("HTTP response ended without receiving EOS message"))}else n.options.onError&&n.options.onError(new Error(new o(e).toString()))}}return e.prototype.opened=function(){this.calledOnOpen||(this.options.onOpen&&this.options.onOpen(),this.calledOnOpen=!0)},e.prototype.open=function(e){e&&this.xhr.setRequestHeader("authorization","Bearer "+e),this.xhr.send()},e.prototype.onChunk=function(){var e=this.xhr.responseText,t=e.lastIndexOf("\n");if(t>this.lastNewlineIndex){var n=e.slice(this.lastNewlineIndex,t).split("\n");this.lastNewlineIndex=t;for(var r=0,o=n;r<o.length;r++){var s=o[r];if(0!==s.length){var i=JSON.parse(s),a=this.onMessage(i);if(null!=a)return a}}}},e.prototype.onMessage=function(e){if(this.gotEOS)return new Error("Got another message after EOS message");if(!Array.isArray(e))return new Error("Message is not an array");if(e.length<1)return new Error("Message is empty array");switch(e[0]){case 0:return null;case 1:return this.onEventMessage(e);case 255:return this.onEOSMessage(e);default:return new Error("Unknown Message: "+JSON.stringify(e))}},e.prototype.onEventMessage=function(e){if(4!==e.length)return new Error("Event message has "+e.length+" elements (expected 4)");var t=(e[0],e[1]),n=e[2],r=e[3];return"string"!=typeof t?new Error("Invalid event ID in message: "+JSON.stringify(e)):"object"!=typeof n||Array.isArray(n)?new Error("Invalid event headers in message: "+JSON.stringify(e)):void(this.options.onEvent&&this.options.onEvent({eventId:t,headers:n,body:r}))},e.prototype.onEOSMessage=function(e){if(4!==e.length)return new Error("EOS message has "+e.length+" elements (expected 4)");var t=(e[0],e[1]),n=e[2];e[3];return"number"!=typeof t?new Error("Invalid EOS Status Code"):"object"!=typeof n||Array.isArray(n)?new Error("Invalid EOS Headers"):void(this.gotEOS=!0)},e.prototype.abort=function(e){this.xhr.abort(),e?this.options.onError&&this.options.onError(e):this.options.onEnd&&this.options.onEnd()},e}(),i=function(){function e(e){this.options=e;var t=e.cluster.replace(/\/$/,"");this.baseURL=(e.encrypted!==!1?"https":"http")+"://"+t,this.XMLHttpRequest=e.XMLHttpRequest||window.XMLHttpRequest}return e.prototype.request=function(e){var t=this.createXHR(this.baseURL,e);return new Promise(function(n,r){t.onreadystatechange=function(){4===t.readyState&&(200===t.status?n(t.responseText):r(new o(t)))},t.send(JSON.stringify(e.body))})},e.prototype.newSubscription=function(e){return new s(this.createXHR(this.baseURL,{method:"SUBSCRIBE",path:e.path,headers:e.headers,body:null}),e)},e.prototype.createXHR=function(e,t){var n=this.XMLHttpRequest,r=new n,o=t.path.replace(/^\/+/,""),s=e+"/"+o;r.open(t.method.toUpperCase(),s,!0),t.body&&r.setRequestHeader("content-type","application/json");for(var i in t.headers)r.setRequestHeader(i,t.headers[i]);return r},e}();t.BaseClient=i;var a=function(){function e(e){this.jwt=e}return e.prototype.authorize=function(){var e=this;return new Promise(function(t,n){t(e.jwt)})},e}();t.SimpleTokenAuthorizer=a;var p=function(){function e(e){this.authServerUrl=e,this.accessToken=null}return e.prototype.authorize=function(){var e=this;return new Promise(function(t,n){if(null!=e.accessToken&&Date.now()<1e3*JSON.parse(r(e.accessToken.split(".")[1])).exp)t(e.accessToken);else{var o=new XMLHttpRequest;o.onreadystatechange=function(){4===o.readyState&&(200<=o.status&&o.status<300?(e.accessToken=JSON.parse(o.responseText).access_token,t(e.accessToken)):n(new Error("Unexpected status code in response from auth server: "+o.status)))},o.open("POST",e.authServerUrl,!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.send("grant_type=client_credentials&credentials=jim")}})},e}();t.AuthServerAuthorizer=p;var u=function(){function e(e,t){this.feedName=e,this.app=t}return e.prototype.subscribe=function(e){return this.app.subscribe({path:"feeds/"+this.feedName,headers:e.lastEventId?{"Last-Event-Id":e.lastEventId}:{},onOpen:e.onOpen,onEvent:e.onItem,onEnd:function(){e.onError(new Error("Unexpected end to Feed subscription"))},onError:e.onError})},e.prototype.append=function(e){var t="feeds/"+this.feedName;return this.app.request({method:"POST",path:t,body:{items:[e]}})},e}(),h=function(){function e(e){this.appId=e.appId,this.authorizer=e.authorizer,this.client=e.client||new i({cluster:e.cluster||"api.private-beta-1.pusherplatform.com",encrypted:e.encrypted})}return e.prototype.request=function(e){var t=this;return e.path=this.absPath(e.path),!e.jwt&&this.authorizer?this.authorizer.authorize().then(function(n){return t.client.request(Object.assign(e,{jwt:n}))}):this.client.request(e)},e.prototype.subscribe=function(e){e.path=this.absPath(e.path);var t=this.client.newSubscription(e);return e.jwt?t.open(e.jwt):this.authorizer?this.authorizer.authorize().then(function(e){t.open(e)}).catch(function(e){t.abort(e)}):t.open(null),t},e.prototype.feed=function(e){return new u(e,this)},e.prototype.absPath=function(e){return("/apps/"+this.appId+"/"+e).replace(/\/+/g,"/").replace(/\/+$/,"")},e}();t.App=h}])});